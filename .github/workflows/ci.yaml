name: PetClinic CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, customers-service, vets-service, visits-service]
    
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v4

      - name: Set Image Tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: |
          mvn clean package -pl spring-petclinic-${{ matrix.service }} -am -DskipTests

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          echo "üê≥ Building spring-petclinic-${{ matrix.service }}"
          docker build \
            -f spring-petclinic-${{ matrix.service }}/Dockerfile \
            -t $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:$IMAGE_TAG \
            -t $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:latest \
            .
          docker push $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:$IMAGE_TAG
          docker push $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:latest
          echo "‚úÖ Pushed: $IMAGE_TAG"

  # üéØ PR ÏÉùÏÑ± (ÏûêÎèô Î∞∞Ìè¨ ÎåÄÏã†)
  create-deployment-pr:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitOps Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          token: ${{ secrets.GIT_TOKEN }}
          ref: main

      - name: Update Image Tags
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
        run: |
          echo "================================================"
          echo "üìù Updating values.yaml with tag: $IMAGE_TAG"
          echo "================================================"
          
          for service in api-gateway customers vets visits; do
            VALUES_FILE="apps/${service}-service/values.yaml"
            
            if [ -f "$VALUES_FILE" ]; then
              echo "Updating ${service}-service..."
              sed -i "s|tag: .*|tag: ${IMAGE_TAG}|g" $VALUES_FILE
            fi
          done
          
          echo "‚úÖ All values.yaml files updated!"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GIT_TOKEN }}
          commit-message: "üöÄ Deploy image tag ${{ needs.build-and-push.outputs.image-tag }}"
          branch: deploy-${{ needs.build-and-push.outputs.image-tag }}
          delete-branch: true
          title: "üöÄ Deploy ${{ needs.build-and-push.outputs.image-tag }}"
          body: |
            ## Deployment Request
            
            **Image Tag:** `${{ needs.build-and-push.outputs.image-tag }}`
            **Triggered by:** @${{ github.actor }}
            **Source Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            **Workflow:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### üì¶ Services Updated:
            - `api-gateway-service`
            - `customers-service`
            - `vets-service`
            - `visits-service`
            
            ### ‚úÖ Review Checklist:
            - [ ] Image tag is correct
            - [ ] All services updated
            - [ ] Ready for deployment to EKS
            
            ---
            
            **‚ö†Ô∏è Please review and approve before merging!**
            
            After merge, ArgoCD will automatically deploy to the cluster.
          labels: |
            deployment
            automated
            gitops
          assignees: ${{ github.actor }}
