name: PetClinic CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, customers-service, vets-service, visits-service]
    
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}

    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v4

      - name: Set Image Tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_ENV

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: |
          mvn clean package -pl spring-petclinic-${{ matrix.service }} -am -DskipTests

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "ğŸ³ Building: spring-petclinic-${{ matrix.service }}"
          echo "ğŸ“¦ Tag: ${{ env.IMAGE_TAG }}"
          
          docker build \
            -f spring-petclinic-${{ matrix.service }}/Dockerfile \
            -t $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:${{ env.IMAGE_TAG }} \
            -t $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:latest \
            .
          
          docker push $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:${{ env.IMAGE_TAG }}
          docker push $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:latest
          
          echo "âœ… Pushed: $ECR_REGISTRY/spring-petclinic-${{ matrix.service }}:${{ env.IMAGE_TAG }}"

  # ğŸ¯ í•µì‹¬: Manifest ì—…ë°ì´íŠ¸
  update-gitops-repo:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitOps Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          token: ${{ secrets.GIT_TOKEN }}
          ref: main

      - name: Update Image Tags in Helm Values
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
        run: |
          echo "================================================"
          echo "ğŸ“ Updating Helm values with image tag: $IMAGE_TAG"
          echo "================================================"
          
          # ê° ì„œë¹„ìŠ¤ì˜ values.yaml ì—…ë°ì´íŠ¸
          for service in api-gateway customers vets visits; do
            VALUES_FILE="apps/${service}-service/values.yaml"
            
            if [ -f "$VALUES_FILE" ]; then
              echo "Updating ${service}-service..."
              
              # image.tag ì—…ë°ì´íŠ¸
              sed -i "s|tag: .*|tag: ${IMAGE_TAG}|g" $VALUES_FILE
              
              # ë˜ëŠ” yq ì‚¬ìš© (ë” ì•ˆì „)
              # yq eval -i ".image.tag = \"${IMAGE_TAG}\"" $VALUES_FILE
            fi
          done
          
          echo "âœ… All values.yaml updated!"

      - name: Commit and Push Changes
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add apps/*/values.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Update image tags to ${IMAGE_TAG}
            
            Updated by GitHub Actions
            Source commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}"
            
            git push
            
            echo "================================================"
            echo "âœ… GitOps repo updated successfully!"
            echo "ğŸ”„ ArgoCD will sync automatically"
            echo "================================================"
          fi

  # ğŸ“Š ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify-completion:
    needs: update-gitops-repo
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline Complete
        run: |
          echo "================================================"
          echo "âœ… CI/CD Pipeline Completed!"
          echo "================================================"
          echo "ğŸ“¦ Images pushed to ECR"
          echo "ğŸ“ GitOps repo updated"
          echo "ğŸ”„ ArgoCD will deploy in 1-3 minutes"
          echo ""
          echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "================================================"
